<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scout Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-theme-bg-color: #f0f2f5; --primary: #0088cc; --success: #2ecc71; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--tg-theme-bg-color); margin: 0; padding: 0; }

        /* –ò–∫–æ–Ω–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã */
        #cart-badge {
            position: fixed; bottom: 20px; right: 20px; background: var(--primary);
            color: white; width: 60px; height: 60px; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1000; font-weight: bold;
        }

        /* –ü–æ–º–µ—Ç–∫–∞ "–í –∫–æ—Ä–∑–∏–Ω–µ" –Ω–∞ —Å–µ—Ç–∫–µ */
        .selected-badge {
            position: absolute; top: 5px; right: 5px; background: var(--success);
            color: white; border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
        }

        .item-card { position: relative; background: white; padding: 10px; border-radius: 12px; text-align: center; }
        .item-card img { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; }

        /* –≠–∫—Ä–∞–Ω –∫–æ—Ä–∑–∏–Ω—ã */
        #screen-cart { display: none; padding: 15px; background: white; min-height: 100vh; }
        .cart-item { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding: 10px 0; }
        .cart-item img { width: 50px; height: 50px; border-radius: 5px; }

        /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        #main-content { padding: 15px; }
        .nav { color: var(--primary); font-weight: bold; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; }
        .btn { border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-add { background: var(--primary); color: white; }
        .btn-confirm { background: var(--success); color: white; margin-top: 20px; }
        .btn-remove { background: #ff7675; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="cart-badge" onclick="showCart()">üõí <span id="cart-count">0</span></div>

    <div id="main-content">
        <div id="screen-main">
            <h1 style="text-align: center;">SCOUT STORE</h1>
            <div onclick="openCatalog('male')" style="background:white; padding:20px; border-radius:15px; margin-bottom:10px; text-align:center;">üëü –ú—É–∂—Å–∫–∞—è –æ–±—É–≤—å</div>
            <div onclick="openCatalog('female')" style="background:white; padding:20px; border-radius:15px; text-align:center;">üë† –ñ–µ–Ω—Å–∫–∞—è –æ–±—É–≤—å</div>
        </div>

        <div id="screen-catalog" style="display:none;">
            <div class="nav" onclick="showMain()">‚¨Ö –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div id="catalog-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"></div>
        </div>

        <div id="screen-product" style="display:none;">
            <div class="nav" onclick="backToCatalog()">‚¨Ö –í –∫–∞—Ç–∞–ª–æ–≥</div>
            <img id="p-img" style="width:100%; border-radius:15px;">
            <h2 id="p-name"></h2>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span id="p-price" style="font-size:24px; color:var(--success); font-weight:bold;"></span>
                <span id="p-box" style="font-size:14px; color:gray; text-align:right;"></span>
            </div>
            <button class="btn btn-add" id="add-btn" onclick="addToCart()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–¥–∑–∞–∫–∞–∑</button>
        </div>

        <div id="screen-cart">
            <div class="nav" onclick="closeCart()">‚¨Ö –ö –ø–æ–∫—É–ø–∫–∞–º</div>
            <h2>–í–∞—à –ø—Ä–µ–¥–∑–∞–∫–∞–∑ (—á–µ—Ä–Ω–æ–≤–∏–∫)</h2>
            <div id="cart-items"></div>
            <div id="cart-total" style="margin-top:20px; font-weight:bold; font-size:18px; text-align:right;"></div>
            <button class="btn btn-confirm" onclick="confirmOrder()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ø–æ–ª—É—á–∏—Ç—å PDF</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let allProducts = [];
        let cart = JSON.parse(localStorage.getItem('scout_cart') || '[]');
        let currentCategory = '';
        let currentProduct = null;

        async function init() {
            const res = await fetch('products.json?v=' + Date.now());
            allProducts = await res.json();
            updateCartBadge();
        }

        function openCatalog(cat) {
            currentCategory = cat;
            document.getElementById('screen-main').style.display = 'none';
            document.getElementById('screen-catalog').style.display = 'block';
            renderItems();
        }

        function renderItems() {
            const grid = document.getElementById('catalog-grid');
            grid.innerHTML = '';
            allProducts.filter(p => p.category === currentCategory).forEach(p => {
                const inCart = cart.some(item => item.articul === p.articul);
                const div = document.createElement('div');
                div.className = 'item-card';
                div.onclick = () => showProduct(p);
                div.innerHTML = `
                    ${inCart ? '<div class="selected-badge">‚úì</div>' : ''}
                    <img src="${p.photo}">
                    <div style="font-weight:bold;">$ ${parseFloat(p.price).toFixed(2)}</div>
                    <div style="font-size:11px;">${p.name}</div>
                `;
                grid.appendChild(div);
            });
        }

        function showProduct(p) {
            currentProduct = p;
            document.getElementById('p-img').src = p.photo;
            document.getElementById('p-name').innerText = p.name;
            document.getElementById('p-price').innerText = `$ ${parseFloat(p.price).toFixed(2)}`;
            document.getElementById('p-box').innerText = `–ó–∞ —è—â–∏–∫ (6 –ø–∞—Ä):\n$ ${(p.price * 6).toFixed(2)}`;
            
            const inCart = cart.some(item => item.articul === p.articul);
            const btn = document.getElementById('add-btn');
            if(inCart) {
                btn.innerText = "‚úì –£–∂–µ –≤ –ø—Ä–µ–¥–∑–∞–∫–∞–∑–µ";
                btn.style.background = "#bdc3c7";
                btn.disabled = true;
            } else {
                btn.innerText = "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ø—Ä–µ–¥–∑–∞–∫–∞–∑";
                btn.style.background = "var(--primary)";
                btn.disabled = false;
            }

            document.getElementById('screen-catalog').style.display = 'none';
            document.getElementById('screen-product').style.display = 'block';
        }

        function addToCart() {
            cart.push(currentProduct);
            localStorage.setItem('scout_cart', JSON.stringify(cart));
            updateCartBadge();
            backToCatalog();
        }

        function updateCartBadge() {
            const badge = document.getElementById('cart-badge');
            const count = document.getElementById('cart-count');
            if(cart.length > 0) {
                badge.style.display = 'flex';
                count.innerText = cart.length;
            } else {
                badge.style.display = 'none';
            }
        }

        function showCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;
            cart.forEach((item, index) => {
                total += item.price * 6;
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.photo}">
                        <div style="flex-grow:1;">
                            <div style="font-size:14px; font-weight:bold;">${item.name}</div>
                            <div style="font-size:12px; color:gray;">–ê—Ä—Ç: ${item.articul} | $${(item.price*6).toFixed(2)}</div>
                        </div>
                        <button class="btn-remove" onclick="removeFromCart(${index})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>`;
            });
            document.getElementById('cart-total').innerText = `–ò—Ç–æ–≥–æ: $ ${total.toFixed(2)}`;
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('screen-cart').style.display = 'block';
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            localStorage.setItem('scout_cart', JSON.stringify(cart));
            updateCartBadge();
            showCart();
            if(cart.length === 0) closeCart();
        }

        function confirmOrder() {
            const orderData = {
                items: cart,
                total: cart.reduce((sum, item) => sum + (item.price * 6), 0)
            };
            tg.sendData(JSON.stringify(orderData));
            cart = [];
            localStorage.removeItem('scout_cart');
        }

        function closeCart() {
            document.getElementById('screen-cart').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            renderItems();
        }

        function showMain() {
            document.getElementById('screen-catalog').style.display = 'none';
            document.getElementById('screen-main').style.display = 'block';
        }

        function backToCatalog() {
            document.getElementById('screen-product').style.display = 'none';
            document.getElementById('screen-catalog').style.display = 'block';
            renderItems();
        }

        init();
    </script>
</body>
</html>
