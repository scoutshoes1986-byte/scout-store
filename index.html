<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scout Store 1.2.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-theme-bg-color: #f0f2f5; --primary: #0088cc; --success: #2ecc71; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--tg-theme-bg-color); margin: 0; padding: 0; -webkit-user-select: none; }
        #loader-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #cart-badge { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 1000; font-size: 24px; cursor: pointer; }
        #cart-count { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px; border: 2px solid white; }
        
        #main-content { padding: 15px; display:none; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        .sort-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .sort-btn { background: white; border: 1px solid #ddd; padding: 8px 12px; border-radius: 20px; font-size: 12px; white-space: nowrap; cursor: pointer; color: #555; transition: 0.2s; }
        .sort-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card { background: white; padding: 10px; border-radius: 12px; position: relative; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .item-card img { width: 100%; height: 130px; object-fit: cover; border-radius: 8px; }
        .selected-mark { position: absolute; top: 5px; right: 5px; background: var(--success); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; border: 2px solid white; }
        
        .btn { border: none; padding: 15px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .btn-add { background: var(--primary); color: white; }
        .btn-confirm { background: var(--success); color: white; margin-top: 20px; }
        
        #screen-cart { display: none; padding: 15px; background: #fff; min-height: 100vh; position: fixed; top: 0; left: 0; width: 100%; box-sizing: border-box; z-index: 2000; overflow-y: auto; }
        .cart-item { display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #eee; padding: 15px 0; }
        .cart-item img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; }
        .cart-info { flex-grow: 1; }
        .cart-controls { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .qty-btn { background: #eef1f4; border: none; width: 32px; height: 32px; border-radius: 8px; font-size: 18px; font-weight: bold; color: var(--primary); cursor: pointer; }
        .qty-num { font-weight: bold; font-size: 16px; min-width: 20px; text-align: center; }

        .nav { color: var(--primary); font-weight: bold; cursor: pointer; margin-bottom: 15px; display: block; }
        .cat-card { background:white; padding:30px; border-radius:15px; margin-bottom:15px; text-align:center; border:1px solid #ddd; font-weight: bold; font-size: 18px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="loader-screen"><div class="spinner"></div></div>
    <div id="cart-badge" onclick="showCart()">üõí<span id="cart-count">0</span></div>

    <div id="main-content">
        <div id="screen-main">
            <h2 style="text-align:center;">SCOUT STORE</h2>
            <div class="cat-card" onclick="openCatalog('male')">üëü –ú–£–ñ–°–ö–ê–Ø –û–ë–£–í–¨</div>
            <div class="cat-card" onclick="openCatalog('female')">üë† –ñ–ï–ù–°–ö–ê–Ø –û–ë–£–í–¨</div>
        </div>

        <div id="screen-catalog" style="display:none;">
            <div class="nav" onclick="showMain()">‚¨Ö –ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
            
            <div class="sort-bar">
                <div class="sort-btn active" id="sort-default" onclick="setSort('default')">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</div>
                <div class="sort-btn" id="sort-asc" onclick="setSort('asc')">–î–µ—à–µ–≤–ª–µ üìà</div>
                <div class="sort-btn" id="sort-desc" onclick="setSort('desc')">–î–æ—Ä–æ–∂–µ üìâ</div>
            </div>

            <div id="catalog-grid" class="grid"></div>
        </div>

        <div id="screen-product" style="display:none;">
            <div class="nav" onclick="backToCatalog()">‚¨Ö –í –∫–∞—Ç–∞–ª–æ–≥</div>
            <img id="p-img" style="width:100%; border-radius:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2 id="p-name" style="margin-top:15px; margin-bottom:5px;"></h2>
            <p id="p-art" style="color:gray; margin:0; font-size: 14px;"></p>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <div><small>–¶–µ–Ω–∞ –∑–∞ –ø–∞—Ä—É:</small><div id="p-price" style="font-size:24px; color:var(--success); font-weight:bold;"></div></div>
                <div id="p-box" style="text-align:right; color:gray; font-size:14px; white-space: pre-line;"></div>
            </div>
            <button class="btn btn-add" id="add-btn" onclick="addToCart()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–æ–±</button>
        </div>
    </div>

    <div id="screen-cart">
        <div class="nav" onclick="closeCart()">‚¨Ö –ù–∞–∑–∞–¥</div>
        <h3>–í–∞—à –ø—Ä–µ–¥–∑–∞–∫–∞–∑</h3>
        <div id="cart-items"></div>
        <div id="cart-total" style="margin-top:20px; font-weight:bold; font-size:18px; text-align:right; border-top: 2px solid #eee; padding-top:10px;"></div>
        <button class="btn btn-confirm" onclick="confirmOrder()">‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let allProducts = [];
        let cart = {};
        let currentCategory = '';
        let currentSort = 'default'; // –¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏

        async function init() {
            try {
                const res = await fetch('products.json?v=' + Date.now());
                allProducts = await res.json();
                document.getElementById('loader-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } catch (e) { 
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"); 
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function setSort(type) {
            currentSort = type;
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('sort-' + type).classList.add('active');
            renderItems();
        }

        function openCatalog(cat) {
            currentCategory = cat;
            document.getElementById('screen-main').style.display = 'none';
            document.getElementById('screen-catalog').style.display = 'block';
            renderItems();
        }

        function showMain() {
            document.getElementById('screen-catalog').style.display = 'none';
            document.getElementById('screen-main').style.display = 'block';
        }

        function renderItems() {
            const grid = document.getElementById('catalog-grid');
            grid.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            let filtered = allProducts.filter(p => p.category === currentCategory);

            // –ó–∞—Ç–µ–º —Å–æ—Ä—Ç–∏—Ä—É–µ–º
            if (currentSort === 'asc') {
                filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
            } else if (currentSort === 'desc') {
                filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
            }

            filtered.forEach(p => {
                const inCart = cart[p.articul];
                const div = document.createElement('div');
                div.className = 'item-card';
                div.onclick = () => showProduct(p);
                div.innerHTML = `
                    ${inCart ? '<div class="selected-mark">‚úì</div>' : ''}
                    <img src="${p.photo}">
                    <div style="font-weight:bold; margin-top:10px;">$ ${parseFloat(p.price).toFixed(2)}</div>
                    <div style="font-size:11px; color:gray;">${p.name}</div>
                `;
                grid.appendChild(div);
            });
        }
        
        // --- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (showProduct, addToCart, changeQty, updateCartBadge, showCart, closeCart, confirmOrder) ---
        // –ö–æ–¥ —Ñ—É–Ω–∫—Ü–∏–π –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–∞–∫–∏–º –∂–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –æ—Ç–≤–µ—Ç–µ, –Ω–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ.
        
        function backToCatalog() {
            document.getElementById('screen-product').style.display = 'none';
            document.getElementById('screen-catalog').style.display = 'block';
        }

        function showProduct(p) {
            currentProduct = p;
            document.getElementById('p-img').src = p.photo;
            document.getElementById('p-name').innerText = p.name;
            document.getElementById('p-art').innerText = "–ê—Ä—Ç: " + p.articul;
            document.getElementById('p-price').innerText = `$ ${parseFloat(p.price).toFixed(2)}`;
            document.getElementById('p-box').innerText = `–ö–æ—Ä–æ–± (${p.Korob} –ø–∞—Ä):\n$ ${parseFloat(p.price_opt).toFixed(2)}`;
            document.getElementById('screen-catalog').style.display = 'none';
            document.getElementById('screen-product').style.display = 'block';
        }

        function addToCart() {
            const art = currentProduct.articul;
            if (!cart[art]) cart[art] = { ...currentProduct, boxes: 1 };
            updateCartBadge();
            showCart();
        }

        function changeQty(art, delta) {
            if (cart[art]) {
                cart[art].boxes += delta;
                if (cart[art].boxes <= 0) delete cart[art];
                updateCartBadge();
                showCart();
            }
        }

        function updateCartBadge() {
            const count = Object.keys(cart).length;
            document.getElementById('cart-badge').style.display = count > 0 ? 'flex' : 'none';
            document.getElementById('cart-count').innerText = count;
        }

        function showCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let totalMoney = 0;
            let totalPairs = 0;
            const items = Object.values(cart);

            items.forEach((item) => {
                const itemTotal = parseFloat(item.price_opt) * item.boxes;
                totalMoney += itemTotal;
                totalPairs += (item.boxes * item.Korob);
                container.innerHTML += `
                    <div class="cart-item">
                        <img src="${item.photo}">
                        <div class="cart-info">
                            <b>${item.name}</b><br><small>–ê—Ä—Ç: ${item.articul}</small>
                            <div class="cart-controls">
                                <button class="qty-btn" onclick="changeQty('${item.articul}', -1)">-</button>
                                <span class="qty-num">${item.boxes} –∫–æ—Ä.</span>
                                <button class="qty-btn" onclick="changeQty('${item.articul}', 1)">+</button>
                                <b style="margin-left:auto;">$ ${itemTotal.toFixed(2)}</b>
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('cart-total').innerHTML = `–í—Å–µ–≥–æ: ${totalPairs} –ø–∞—Ä<br>–°—É–º–º–∞: $ ${totalMoney.toFixed(2)}`;
            document.getElementById('screen-cart').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
        }

        function closeCart() { 
            document.getElementById('screen-cart').style.display = 'none'; 
            document.getElementById('main-content').style.display = 'block';
        }

        function confirmOrder() {
            const items = Object.values(cart);
            if (items.length === 0) return;
            const finalData = {
                action: "order",
                items: items.map(i => ({
                    articul: i.articul,
                    name: i.name,
                    boxes: i.boxes,
                    pairs_per_box: i.Korob,
                    price: parseFloat(i.price),
                    photo: i.photo
                }))
            };
            tg.sendData(JSON.stringify(finalData));
            tg.close();
        }

        init();
    </script>
</body>
</html>
